<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Game</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">

<div class="container py-4">

    <h1 class="text-center mb-0 fw-bold">Kaari Tirri<br></h1>
    <div class="text-center mt-0 mb-3"><small>beta 1.0</small></div>
    <div class="text-center mb-4">room:<span id="roomID">?</span></div>

    <!-- JOIN ROOM -->
    <div id="joinSection" class="card shadow-sm p-4 mx-auto" style="max-width: 450px;">
        <div class="mb-3">
            <input type="text" id="userName" class="form-control" placeholder="Enter Your Name">
        </div>
        <div class="mb-3">
            <input type="text" id="roomId" class="form-control" placeholder="Enter Room ID" value="1">
        </div>
        <button id="joinBtn" class="btn btn-primary w-100">Join Room</button>
    </div>

    <!-- GAME + CHAT LAYOUT -->
    <div id="gameWrapper" class="mt-4 d-none">

        <div class="row">
            
            <!-- GAME AREA -->
            <div class="col-lg-9 col-md-8 mb-4">
                <div class="card shadow-sm game-box p-4">
                    <h3 class="fw-bold mb-3">Playing as: <span id="userNameDisplay"></span></h3>
                    
                    <button id="startGame" class="btn btn-success mb-3">Start Game</button>
                    
                    <div id="auctionPanel" class="input-group p-2">
                        <input type="number" id="bidAmount" class="form-control" placeholder="Enter your bid">
                        <button id="bidBtn" class="btn btn-success">Place Bid</button>
                        <button id="passBtn" class="btn btn-primary">Pass</button>
                    </div>

                    <div id="powerSuitPanel" class="input-group p-2" hidden>
                        <select name="powerSuit" id="powerSuitSelect">
                            <option selected disabled>select power suit</option>
                            <option value="Spades">Spades</option>
                            <option value="Hearts">Hearts</option>
                            <option value="Diamonds">Diamonds</option>
                            <option value="Clubs">Clubs</option>
                        </select>
                        <button id="powerSuitBtn" class="btn btn-primary">Select Power Suit</button>
                    </div>

                    <div id="partnerSelectionPanel" class="input-group p-2" hidden>
                        
                        <select id="partnerSelect" multiple></select>
                        <button id="partnerSelectBtn" class="btn btn-primary">Select Partners</button>
                    </div>

                    <div id="roundOutput" class="border bg-white p-3 rounded" style="min-height: 200px;">
                        Waiting for game updates...
                    </div>
                    <h4>Round Score: <span id="roundScore">0</span>, Round Leader: <span id="roundLeader">...</span> </h4>
                    <div id="playerHandDiv" class="border bg-white p-3 rounded" style="max-height: 600px; overflow-y: auto;">

                    </div>
                </div>
            </div>

            <!-- CHAT PANEL -->
            <div class="col-lg-3 col-md-4">

                <div class="card shadow-sm chat-panel">
                    <div class="card-header bg-primary text-white fw-bold">
                        Chat
                    </div>

                    <div id="messages" class="messages p-3"></div>

                    <div class="input-group p-2">
                        <input type="text" id="message" class="form-control" placeholder="Message">
                        <button id="sendBtn" class="btn btn-primary">Send</button>
                    </div>
                </div>

            </div>

        </div>

    </div>

</div>

<!-- Socket.io -->
<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io({ autoConnect: false });

    const userNameInput = document.getElementById('userName');
    const roomInput = document.getElementById('roomId');
    const joinBtn = document.getElementById('joinBtn');

    const userNameDisplay = document.getElementById('userNameDisplay');
    const startGameBtn = document.getElementById('startGame');

    const auctionPanel = document.getElementById('auctionPanel');
    const bidAmountInput = document.getElementById('bidAmount');
    const bidBtn = document.getElementById('bidBtn');
    const passBtn = document.getElementById('passBtn');

    const powerSuitPanel = document.getElementById('powerSuitPanel');
    const powerSuitSelect = document.getElementById('powerSuitSelect');
    const powerSuitBtn = document.getElementById('powerSuitBtn');

    const partnerSelectionPanel = document.getElementById('partnerSelectionPanel')
    const partnerSelect = document.getElementById('partnerSelect')
    const partnerSelectBtn = document.getElementById('partnerSelectBtn');
    
    const chatSection = document.getElementById('chatSection');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('message');
    const messagesDiv = document.getElementById('messages');
    
    const joinSection = document.getElementById('joinSection');
    const gameWrapper = document.getElementById('gameWrapper');

    const roundOutput = document.getElementById('roundOutput');
    const roundLeader = document.getElementById('roundLeader');
    const roundScore = document.getElementById('roundScore');

    const playerHandDiv = document.getElementById('playerHandDiv');

    var gameState = {}
    var playerName = ""

    joinBtn.addEventListener('click', () => {
        const roomId = roomInput.value.trim();
        const name = userNameInput.value.trim();
        if (!roomId || !name) return;

        socket.connect();

        socket.emit('joinRoom', { roomId, name });
        playerName = name;

        joinSection.classList.add("d-none");
        gameWrapper.classList.remove("d-none");
        userNameDisplay.textContent = name;
    });

    sendBtn.addEventListener('click', () => {
        const msg = messageInput.value.trim();
        if (!msg) return;
        socket.emit('message', msg);
        messageInput.value = '';
    });

    startGameBtn.addEventListener('click', () => {
        socket.emit('gameStart');
    });

    bidBtn.addEventListener('click', () => {
        const bidAmount = parseInt(bidAmountInput.value);
        if (isNaN(bidAmount) || bidAmount < 0) return;
        socket.emit('bidPlaced', bidAmount);
        bidAmountInput.value = '';
    });
    passBtn.addEventListener('click', () => {
        socket.emit('bidPlaced', 0);
        bidBtn.disabled = true
    })

    powerSuitBtn.addEventListener('click', ()=>{
        const powerSuit = powerSuitSelect.value;
        if(!powerSuit) return
        socket.emit('powerSuitSelected', powerSuit);
    })

    partnerSelectBtn.addEventListener('click', ()=>{
        const select = document.getElementById('partnerSelect');
        const values = Array.from(select.selectedOptions).map(o => JSON.parse(o.value));

        socket.emit('partnersSelected', values);

    })

    socket.on('gameStarted', () => {
        startGameBtn.hidden = true;
    })

    socket.on('gameStateUpdate', (data) => {
        localStorage.gameState = JSON.stringify(data)
        gameState = data
        const hand = gameState.playerGameState.hand;
        playerHandDiv.innerHTML = ''

        const grouped = {
            Spades: [],
            Hearts: [],
            Diamonds: [],
            Clubs: []
        };

        hand.forEach(card => {
            grouped[card.suit].push(card);
        });

        for (const suit in grouped) {
            grouped[suit].sort((a, b) => b.power - a.power);
            const h4 = document.createElement('h4')
            h4.innerHTML = suit

            playerHandDiv.appendChild(h4)

            const div = document.createElement('div');
            div.classList.add('btn-group')
            grouped[suit].forEach(card => {
                const card_img = document.createElement('img');
                card_img.classList.add(`${suit.toLowerCase()}`, 'hand_card');
                card_img.src = `/cards/${card.suit.toLowerCase()}/${card.number.toLowerCase()}.png`;
                card_img.style.pointerEvents = 'none';
                card_img.style.width = '80px';

                card_img.alt = `${card.number} of ${card.suit}`;

                card_img.addEventListener('click',()=>{
                    socket.emit('cardPlayed', card);
                    document.querySelectorAll('.hand_card').forEach(c => {c.style.pointerEvents = 'none';});
                })
                div.appendChild(card_img)
            })
            playerHandDiv.appendChild(div)
        }
        
        roundScore.innerHTML = gameState.public.roundScore;
        roundLeader.innerHTML = gameState.public.roundLeader;

    
    });

    socket.on('message', (msg) => {
        messagesDiv.innerHTML += `<p class="msg">${msg}</p>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    socket.on('auctionWon', ()=>{
        auctionPanel.hidden = true;
    })

    socket.on('auctionWinner', ()=>{
        powerSuitPanel.hidden = false;
    })

    socket.on('powerSuitSelected', (data)=>{
        const deck = data.defaultDeck
        powerSuitPanel.hidden = true;
        
        deck.forEach(card => {
            const option = document.createElement('option')
            option.value =  JSON.stringify(card);
            option.innerHTML = `${card.number} of ${card.suit}`
            partnerSelect.appendChild(option)
        });
        
        partnerSelectionPanel.hidden = false;

    })

    socket.on('newRound', ()=>{
        roundOutput.innerHTML = ""
        partnerSelectionPanel.hidden = true;
    })

    socket.on('playerTurn', (leadSuit)=>{
        const hasLeadSuit = JSON.parse(localStorage.gameState).playerGameState.hand.some(c => c.suit == leadSuit)
        if(leadSuit && hasLeadSuit){
            const card_img = document.getElementsByClassName(leadSuit.toLowerCase());
            for (let img of card_img) {
                img.style.pointerEvents = 'auto';
            }
        }else{
            const card_img = document.getElementsByClassName('hand_card');
            for (let img of card_img) {
                img.style.pointerEvents = 'auto';
            }
        }

    })

    socket.on('cardPlayed', (data)=>{
        const card_img = document.createElement('img');
        card_img.src = `/cards/${data.card.suit.toLowerCase()}/${data.card.number.toLowerCase()}.png`;
        card_img.style.width = '80px';
        card_img.alt = `${data.card.number} of ${data.card.suit}`;
        card_img.style.pointerEvents = 'none';

        roundOutput.appendChild(card_img);
    })

    socket.on('gameOver', ()=>{
        socket.disconnect()
        roundOutput.innerHTML += `<h2 class="text-center">Game Over! Winners: ${gameState.public.gameWinners}</h2>`
        console.log("BYE BYE")
    })

    socket.on('connect', () => {
        messagesDiv.innerHTML += `<p class="sys">Connected to server</p>`;
        document.getElementById('roomID').textContent = roomInput.value.trim();
    });

    socket.on('disconnect', () => {
        messagesDiv.innerHTML += `<p class="sys">Disconnected</p>`;
    });


</script>

</body>
</html>
